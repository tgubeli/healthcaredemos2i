<?xml version="1.0" encoding="UTF-8"?>
<!-- Configures the Camel Context -->

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

	<bean id="amqConnectionFactory" class="io.fabric8.mq.core.MQConnectionFactory">
		<property name="userName" value="admin" />
		<property name="password" value="r3dh4t1!" />
	</bean>
	<bean id="amq" class="io.fabric8.mq.camel.AMQComponent"></bean>
	
    <bean class="com.mycompany.camel.spring.FHIRConoverter" id="fhirConoverter"/>

	<camelContext id="LaboratoryService" xmlns="http://camel.apache.org/schema/spring">
		<!-- here is a sample which processes the input files (leaving them in 
			place - see the 'noop' flag) then performs content based routing on the message 
			using XPath -->

		<route id="test">
			<from uri="amq:queue:LABTESTMSG" />
			<log id="_log1" message="Transform Body: ---->${body}" />
			<setHeader headerName="familyName" id="_setHeader2">
				<terser>PID-5-1</terser>
			</setHeader>
			<setHeader headerName="firstName" id="_setHeader3">
				<terser>PID-5-2</terser>
			</setHeader>
			<setHeader headerName="hisId" id="_setHeader4">
				<terser>PID-10-4</terser>
			</setHeader>
			<setHeader headerName="testcontent" id="_setHeader5">
				<terser>OBR-4-2</terser>
			</setHeader>
			<bean id="_bean1"
				method="convertFHIRformat(${headers.firstName},${headers.familyName},${headers.hisId},${headers.testcontent})"
				ref="fhirConoverter" />
			<wireTap id="_wireTap1" uri="amq:queue:msgtransmit" />
			<to id="_to1" uri="direct:doRegistry" />
		</route>

		<route id="_route2">
			<from id="_from1" uri="direct:doRegistry" />
			<setBody id="_setBody1">
				<simple>One Patient admitted</simple>
			</setBody>
			<to id="_to2" uri="direct:doTestDisplay" />
		</route>

		<route id="doTestDisplay">
			<from id="_from2" uri="direct:doTestDisplay" />
			<log id="_log2" message="Log doTestDisplay" />
			<to id="_to3" uri="websocket://demo?port=9294&amp;sendToAll=true" />
		</route>

		<route id="ordertest">
			<from id="_from3" uri="direct:ordertest" />
			<log id="_log3" message="Log ordertest" />
			<setHeader headerName="perscription" id="_setHeader1">
				<xpath resultType="String">/fhir:Bundle/fhir:entry/fhir:resource/fhir:DiagnosticOrder/fhir:item/fhir:code/fhir:coding/fhir:display/@value</xpath>
			</setHeader>
			<setBody id="_setBody2">
				<simple>Accept test : ${headers.perscription}</simple>
			</setBody>
			<to id="_to4" uri="direct:doTestDisplay" />
		</route>
	</camelContext>
</beans>
